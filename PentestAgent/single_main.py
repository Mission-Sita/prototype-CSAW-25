#!/usr/bin/env python3
import json
from pathlib import Path
import asyncio
# Import baseline NYU CTF classes
from nyuctf.challenge import CTFChallenge
from nyuctf.dataset import CTFDataset
from chalenges_integrate.environment import CTFEnvironment    # or from env import CTFEnvironment if you renamed it

# init(autoreset=True)

from agents import set_tracing_disabled
set_tracing_disabled(True)

from agents.mcp import MCPServerStdio, MCPServerSse

DATASET_FILE = "./NYU_CTF_Bench/test_dataset.json"       # or development_dataset.json

def load_dataset(file_path=DATASET_FILE):
    with open(file_path, "r") as f:
        return json.load(f)

def pick_first_challenge(dataset):
    """Just pick the first challenge from JSON for testing."""
    key, meta = next(iter(dataset.items()))
    print(f"[+] Selected challenge: {key}")
    return meta

def build_ctf_challenge(dataset):
    """Convert JSON metadata to a CTFChallenge object using the first entry in test_dataset.json."""
    ds = CTFDataset(split="test")
    _key, meta = next(iter(dataset.items()))
    return CTFChallenge(
        meta,                 # metadata must include 'path' to the challenge dir
        ds.basedir            # base path where the challenge files exist
    )

async def main():
    dataset = load_dataset()
    challenge = build_ctf_challenge(dataset)

    # pick a container image based on category
    # For now, hard-coded for quick test
    container_image = "llmctf/2021q-web-no_pass_needed:latest"
    network = "ctfnet"

    # Export CHALLENGE_SERVER_NAME/CHALLENGE_PORT for agent target construction
    import os
    server_name = getattr(challenge, 'server_name', None) or getattr(challenge, 'box', None) or 'challenge'
    port = str(getattr(challenge, 'port', None) or getattr(challenge, 'internal_port', 80))
    os.environ['CHALLENGE_SERVER_NAME'] = server_name
    os.environ['CHALLENGE_PORT'] = "3000"

    env = CTFEnvironment(challenge,container_image,network)

    print("[*] Setting up environment...")
    env.setup()              # starts Docker + copies files


    try:
        print("[*] Environment is ready. Challenge is running.")
        
        try:
            from core.pentest_agent import PentestAgent
            agent = PentestAgent(MCPServerStdio, MCPServerSse)  # no constructor change required
            print("[*] Starting PentestAgent (this may show menus unless workflows are automated)...")
            await agent.run()
        except Exception as e:
            print(f"[!] Exception occurred: {e}")
        input("Press Enter to tear down environment...")
        # try:
        #     print("[*] Importing PentestAgent...")
        #     from core.pentest_agent import PentestAgent
        #     print("[*] Running PentestAgent...")
        #     agent = PentestAgent(MCPServerStdio, MCPServerSse)
        #     await agent.run()
        
        # except ImportError as e:
        #     print(f"Error importing required modules: {e}")
        #     print("Please ensure all dependencies are installed: pip install -r requirements.txt")
        #     sys.exit(1)
        # except KeyboardInterrupt:
        #     print("\nApplication interrupted by user.")
        #     sys.exit(0)
        # except Exception as e:
        #     print(f"Unexpected error: {e}")
        #     import traceback
        #     traceback.print_exc()
        #     sys.exit(1)


        # except Exception as e:
        #     print(f"[!] Exception occurred: {e}")

        
    finally:
        print("[*] Tearing down environment...")
        env.teardown(None, None, None)
        print("[+] Done.")

if __name__ == "__main__":
    asyncio.run(main())
